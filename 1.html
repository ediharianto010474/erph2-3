<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard User</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            text-align: center;
            color: #66ccff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 3rem;
            margin-bottom: 10px;
            width: 100%;
        }

        .welcome {
            font-size: 1.2rem;
            margin-bottom: 0;
            font-weight: bold;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-col, .right-col {
            flex: 1;
            box-sizing: border-box;
        }

        /* Jadual Hari/Masa */
        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .timetable th,
        .timetable td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .timetable th {
            background-color: #005588;
            color: white;
            font-weight: bold;
        }

        .timetable tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .timetable tr:hover {
            background-color: #e0e0e0;
        }

        /* Jadual RPH */
        .rph-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .rph-table th,
        .rph-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .rph-table th {
            background-color: #005588;
            color: white;
            font-weight: bold;
        }

        .rph-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .rph-table tr:hover {
            background-color: #e0e0e0;
        }

        /* Butang */
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #005588;
            color: white;
        }

        .btn-primary:hover {
            background-color: #004466;
        }

        .btn-secondary {
            background-color: #0099cc;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0077aa;
        }

        /* Link Logout */
        .logout-link {
            color: red;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .logout-link:hover {
            background-color: #ffe6e6;
            text-decoration: underline;
        }

        /* Input Date */
        .date-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9rem;
            background-color: white;
            color: #333;
            width: 120px;
            height: 36px;
            box-sizing: border-box;
        }

        /* RPH Form Container (scrollable) */
        .rph-container {
            width: 100%;
            background-color: #f2f2f2;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        /* RPH Template (individual) */
        .rph-template {
            background-color: #9c008d;
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .rph-template h3 {
            text-align: center;
            margin-top: 0;
            background-color: #8b0075;
            padding: 10px;
            border-radius: 5px;
        }

        .rph-template table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .rph-template th,
        .rph-template td {
            border: 1px solid #fff;
            padding: 8px;
            text-align: left;
        }

        .rph-template th {
            background-color: #8b0075;
            font-weight: bold;
        }

        .rph-template input[type="text"],
        .rph-template textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        .rph-template textarea {
            height: 80px;
            resize: vertical;
        }

        /* Notifikasi */
        .notification {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        /* Nota */
        .note {
            font-size: 0.8rem;
            color: #555;
            margin-top: 10px;
            text-align: justify;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- TAJUK -->
        <h1>Dashboard Guru</h1>

        <!-- Action Bar: Selamat Datang & Logout -->
        <div class="action-bar">
            <div>
                <p class="welcome">Selamat Datang : <strong>{ nama guru }</strong></p>
            </div>
            <a href="login.html" class="logout-link" onclick="localStorage.removeItem('loggedInUser'); alert('Anda telah logout.');">Logout</a>
        </div>

        <!-- Layout Utama -->
        <div class="main-layout">
            <!-- Kolom Kiri: Jadual Hari/Masa -->
            <div class="left-col">
                <table class="timetable">
                    <thead>
                        <tr>
                            <th>Hari/Masa</th>
                            <th>710 - 740</th>
                            <th>740 - 810</th>
                            <th>810 - 840</th>
                            <th>840 - 910</th>
                            <th>910 - 940</th>
                            <th>940 - 1000</th>
                            <th>1000 - 1030</th>
                            <th>1030 - 1100</th>
                            <th>1100 - 1130</th>
                            <th>1130 - 1200</th>
                            <th>1200 - 1230</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ISNIN</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td>REHAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>SELASA</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td>REHAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>RABU</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td>REHAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>KHAMIS</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td>REHAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>JUMAAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td>REHAT</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Butang di bawah jadual -->
                <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                    <input type="date" id="rphDate" class="date-input">
                    <button class="btn btn-secondary" onclick="pilihTarikh()">TARIKH RPH</button>
                    <button class="btn btn-secondary" onclick="janaRph()">JANA RPH</button>
                    <button class="btn btn-primary" onclick="saveJadualWaktu()">SIMPAN</button>
                </div>
            </div>

            <!-- Kolom Kanan: Jadual RPH -->
            <div class="right-col">
                <table class="rph-table">
                    <thead>
                        <tr>
                            <th>TARIKH</th>
                            <th>MATAPELAJARAN</th>
                            <th>KELAS</th>
                            <th>REFLEKSI</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>17/02/2025</td><td>BAHASA INGGERIS</td><td>5C</td><td><button class="btn btn-primary">HANTAR</button></td></tr>
                        <tr><td>17/02/2025</td><td>BAHASA INGGERIS</td><td>4C</td><td><button class="btn btn-primary">HANTAR</button></td></tr>
                        <tr><td></td><td></td><td></td><td></td></tr>
                        <tr><td></td><td></td><td></td><td></td></tr>
                        <tr><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Container untuk RPH Templates -->
        <div class="rph-container" id="rphContainer">
            <p style="text-align: center; color: #888;">Pilih tarikh dan tekan “JANA RPH” untuk memulakan.</p>
        </div>

        <!-- Nota -->
        <p class="note">
            GURU AKAN PILIH TARIKH RPH YANG INGIN DIJANA. BILA BUTANG JANA RPH DITEKAN, HASILKAN KESEMUA RPH YANG TERDAPAT DALAM JADUAL WAKTU.
        </p>
    </div>

    <script>
        // Papar nama user
        const user = JSON.parse(localStorage.getItem('loggedInUser'));
        if (user) {
            document.querySelector('.welcome').innerHTML = `Selamat Datang : <strong>${user.name}</strong>`;
            loadJadualWaktu();
        } else {
            alert('Sila login terlebih dahulu.');
            window.location.href = 'login.html';
        }

        // ========================
        // FUNGSI: Muat Jadual Waktu dari JSON
        // ========================
        async function loadJadualWaktu() {
            if (!user) return;

            try {
                const response = await fetch('/public/jadual_waktu.json');
                if (!response.ok) throw new Error('Fail jadual_waktu.json tidak wujud.');

                const allData = await response.json();
                const jadualData = allData[user.name] || [];

                const rows = document.querySelectorAll('.timetable tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    for (let i = 1; i < cells.length; i++) {
                        if (cells[i].textContent.trim() !== "REHAT") {
                            cells[i].textContent = "";
                        }
                    }
                });

                jadualData.forEach(item => {
                    const row = Array.from(rows).find(r => 
                        r.querySelector('td').textContent.trim() === item.hari
                    );
                    if (!row) return;

                    const waktuHeaders = [
                        "710 - 740",
                        "740 - 810",
                        "810 - 840",
                        "840 - 910",
                        "910 - 940",
                        "940 - 1000",
                        "1000 - 1030",
                        "1030 - 1100",
                        "1100 - 1130",
                        "1130 - 1200",
                        "1200 - 1230"
                    ];

                    const colIndex = waktuHeaders.indexOf(item.masa) + 1;
                    if (colIndex <= 0) return;

                    const cell = row.querySelectorAll('td')[colIndex];
                    if (cell && cell.textContent.trim() !== "REHAT") {
                        cell.textContent = `${item.matapelajaran} ${item.kelas}`.trim();
                    }
                });

            } catch (error) {
                console.warn('Tiada data jadual waktu atau fail belum wujud:', error.message);
            }
        }

        // ========================
        // FUNGSI: Simpan Jadual Waktu ke JSON
        // ========================
        function saveJadualWaktu() {
            if (!user) {
                alert('Sila login semula.');
                return;
            }

            const namaGuru = user.name;
            const rows = document.querySelectorAll('.timetable tbody tr');
            const jadualData = [];

            const waktuHeaders = [
                "710 - 740",
                "740 - 810",
                "810 - 840",
                "840 - 910",
                "910 - 940",
                "940 - 1000",
                "1000 - 1030",
                "1030 - 1100",
                "1100 - 1130",
                "1130 - 1200",
                "1200 - 1230"
            ];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const hari = cells[0].textContent.trim();

                for (let i = 1; i < cells.length; i++) {
                    let kandungan = cells[i].textContent.trim();
                    if (!kandungan || kandungan === "REHAT") continue;

                    let matapelajaran = "";
                    let kelas = "";

                    const lastSpaceIndex = kandungan.lastIndexOf(' ');
                    if (lastSpaceIndex > 0) {
                        matapelajaran = kandungan.substring(0, lastSpaceIndex).trim();
                        kelas = kandungan.substring(lastSpaceIndex + 1).trim();
                    } else {
                        const match = kandungan.match(/^([A-Za-z\s]+)(\d+[A-Za-z]*)$/);
                        if (match) {
                            matapelajaran = match[1].trim();
                            kelas = match[2].trim();
                        } else {
                            matapelajaran = kandungan;
                            kelas = "";
                            console.warn(`Format tidak jelas: "${kandungan}" pada ${hari}, ${waktuHeaders[i-1]}`);
                        }
                    }

                    jadualData.push({
                        hari: hari,
                        masa: waktuHeaders[i - 1],
                        matapelajaran: matapelajaran,
                        kelas: kelas
                    });
                }
            });

            if (jadualData.length === 0) {
                alert('❌ Tiada data untuk disimpan. Sila isi jadual waktu terlebih dahulu.');
                return;
            }

            fetch('/save-jadual-waktu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nama_guru: namaGuru,
                    jadual: jadualData
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('✅ Jadual waktu berjaya disimpan!');
                } else {
                    alert('❌ Gagal menyimpan: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('⚠️ Ralat sistem. Sila cuba lagi.');
            });
        }

        // ========================
        // FUNGSI: Pilih Tarikh
        // ========================
        function pilihTarikh() {
            const input = document.getElementById('rphDate');
            if (input) {
                input.focus();
                if (input.showPicker) {
                    input.showPicker();
                }
            } else {
                console.error('Input #rphDate tidak dijumpai!');
                alert('Ralat: Input tarikh tidak dijumpai. Sila muat semula halaman.');
            }
        }

        // ========================
        // FUNGSI: Jana RPH
        // ========================
        async function janaRph() {
            const selectedDate = document.getElementById('rphDate').value;
            if (!selectedDate) {
                alert('Sila pilih tarikh dahulu.');
                return;
            }

            if (!user) {
                alert('Sila login semula.');
                return;
            }

            // Dapatkan hari dari tarikh
            const days = ['AHAD', 'ISNIN', 'SELASA', 'RABU', 'KHAMIS', 'JUMAAT', 'SABTU'];
            const dateObj = new Date(selectedDate);
            const hari = days[dateObj.getDay()];

            console.log('Tarikh dipilih:', selectedDate);
            console.log('Hari:', hari);

            // Muat jadual waktu
            let jadualData = [];
            try {
                const response = await fetch('/public/jadual_waktu.json');
                if (response.ok) {
                    const allData = await response.json();
                    jadualData = allData[user.name] || [];
                    console.log('Jadual waktu:', jadualData);
                } else {
                    console.warn('Fail jadual_waktu.json tidak wujud atau kosong.');
                }
            } catch (error) {
                console.warn('Gagal memuat jadual waktu:', error);
            }

            // Cari kelas untuk hari ini
            const kelasList = [];
            const waktuHeaders = [
                "710 - 740",
                "740 - 810",
                "810 - 840",
                "840 - 910",
                "910 - 940",
                "940 - 1000",
                "1000 - 1030",
                "1030 - 1100",
                "1100 - 1130",
                "1130 - 1200",
                "1200 - 1230"
            ];

            jadualData.forEach(item => {
                if (item.hari === hari) {
                    kelasList.push({
                        matapelajaran: item.matapelajaran,
                        kelas: item.kelas,
                        masa: item.masa
                    });
                }
            });

            console.log('Kelas dijumpai:', kelasList);

            if (kelasList.length === 0) {
                document.getElementById('rphContainer').innerHTML = `
                    <div class="notification">
                        ⚠️ Tiada kelas dijadualkan untuk ${hari}, ${selectedDate}. Sila isi jadual waktu terlebih dahulu.
                    </div>
                `;
                return;
            }

            // Muat draft yang sedia ada
            let draftData = {};
            try {
                const response = await fetch('/public/rph_data.json');
                if (response.ok) {
                    const allDrafts = await response.json();
                    draftData = allDrafts[user.name] && allDrafts[user.name][selectedDate] ? allDrafts[user.name][selectedDate] : [];
                }
            } catch (error) {
                console.warn('Tiada draft sedia ada:', error);
            }

            // Jana template
            let html = '';
            for (let i = 0; i < kelasList.length; i++) {
                const { matapelajaran, kelas, masa } = kelasList[i];
                const draft = draftData.find(d => d.kelas === kelas && d.matapelajaran === matapelajaran);

                // Tentukan SP file
                const spFileMap = {
                    'BI': 'sp-bi.json',
                    'BM': 'sp-bm.json',
                    'MT': 'sp-mt.json',
                    'SN': 'sp-sn.json',
                    'PAI': 'sp-pai.json',
                    'BA': 'sp-ba.json',
                    'PJ': 'sp-pj.json',
                    'PK': 'sp-pk.json',
                    'PM': 'sp-pm.json',
                    'MZ': 'sp-mz.json',
                    'PSV': 'sp-psv.json',
                    'SJ': 'sp-sj.json',
                    'RBT': 'sp-rbt.json'
                };

                const spFile = spFileMap[matapelajaran] || `${matapelajaran.toLowerCase()}.json`;
                let spData = null;
                let unit = '';
                let skill = '';
                let itemData = {
                    standards: '',
                    objectives: '',
                    assessment: '',
                    teaching_aids: ''
                };

                try {
                    const spResponse = await fetch(`/public/${spFile}`);
                    if (spResponse.ok) {
                        spData = await spResponse.json();

                        // Tentukan tahun
                        const kelasDigit = kelas.match(/\d+/)?.[0];
                        if (!kelasDigit) {
                            throw new Error('Tahun tidak dapat ditentukan');
                        }
                        const tahun = `TAHUN ${kelasDigit}`;

                        if (!spData[tahun]) {
                            throw new Error(`Tiada data untuk ${tahun}`);
                        }

                        // Tentukan fasa berdasarkan bulan
                        const bulan = dateObj.getMonth() + 1;
                        const unitList = Object.keys(spData[tahun]);
                        if (unitList.length === 0) {
                            throw new Error('Tiada unit dalam tahun ini');
                        }

                        let unitIndex;
                        if (bulan <= 4) {
                            unitIndex = 0;
                        } else if (bulan <= 8) {
                            unitIndex = Math.floor(unitList.length / 2);
                        } else {
                            unitIndex = unitList.length - 1;
                        }

                        unit = unitList[unitIndex];
                        const skillList = Object.keys(spData[tahun][unit]);
                        if (skillList.length === 0) {
                            throw new Error('Tiada skill dalam unit ini');
                        }

                        let skillIndex;
                        if (bulan <= 4) {
                            skillIndex = 0;
                        } else if (bulan <= 8) {
                            skillIndex = Math.floor(skillList.length / 2);
                        } else {
                            skillIndex = skillList.length - 1;
                        }

                        skill = skillList[skillIndex];
                        const items = spData[tahun][unit][skill];
                        if (items && items.length > 0) {
                            const spItem = items[0];
                            itemData = {
                                standards: spItem.standards || '',
                                objectives: spItem.objectives || '',
                                assessment: Array.isArray(spItem.assessment) ? spItem.assessment.join(', ') : '',
                                teaching_aids: Array.isArray(spItem.aids) ? spItem.aids.join(', ') : ''
                            };
                        }
                    } else {
                        throw new Error('Fail SP tidak wujud');
                    }
                } catch (error) {
                    console.warn(`Gagal memuat data SP untuk ${matapelajaran}:`, error);
                    html += `
                        <div class="notification">
                            ⚠️ RPH tidak dapat dijana untuk ${matapelajaran} — ${error.message}
                        </div>
                    `;
                    continue;
                }

                // Jika ada draft, guna data draft
                if (draft) {
                    itemData = {
                        ...itemData,
                        ...draft
                    };
                }

                const btnText = draft && draft.refleksi ? 'SIMPAN' : 'SIMPAN DRAF';
                const btnId = `saveBtn-${i}`;

                html += `
                    <div class="rph-template" id="rph-${i}">
                        <h3>RANCANGAN PENGAJARAN HARIAN</h3>
                        <table>
                            <tr>
                                <th>DATE</th>
                                <td><input type="text" value="${selectedDate}" readonly></td>
                            </tr>
                            <tr>
                                <th>CLASS</th>
                                <td><input type="text" value="${kelas}" readonly></td>
                            </tr>
                            <tr>
                                <th>UNIT</th>
                                <td><input type="text" value="${unit}" readonly></td>
                            </tr>
                            <tr>
                                <th>SKILL</th>
                                <td><input type="text" value="${skill}" readonly></td>
                            </tr>
                            <tr>
                                <th>STANDARD</th>
                                <td><input type="text" value="${itemData.standards}" readonly></td>
                            </tr>
                            <tr>
                                <th>OBJECTIVES</th>
                                <td><input type="text" value="${itemData.objectives}" readonly></td>
                            </tr>
                            <tr>
                                <th>ASSESSMENT</th>
                                <td><input type="text" value="${itemData.assessment}" readonly></td>
                            </tr>
                            <tr>
                                <th>TEACHING AIDS</th>
                                <td><input type="text" value="${itemData.teaching_aids}" readonly></td>
                            </tr>
                            <tr>
                                <th>REFLEKSI</th>
                                <td><textarea placeholder="Masukkan refleksi pengajaran">${itemData.refleksi || ''}</textarea></td>
                            </tr>
                        </table>
                        <div style="text-align: center; margin-top: 15px;">
                            <button id="${btnId}" class="btn btn-primary" onclick="simpanDraft(${i}, '${selectedDate}', '${kelas}', '${matapelajaran}')">${btnText}</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('rphContainer').innerHTML = html;
        }

        // ========================
        // FUNGSI: Simpan Draft
        // ========================
        async function simpanDraft(index, tarikh, kelas, matapelajaran) {
            if (!user) {
                alert('Sila login semula.');
                return;
            }

            const template = document.getElementById(`rph-${index}`);
            const refleksi = template.querySelector('textarea').value;

            // Baca data dari template
            const data = {
                kelas: kelas,
                matapelajaran: matapelajaran,
                unit: template.querySelector('input[readonly][value*="UNIT"] + td input').value,
                skill: template.querySelector('input[readonly][value*="SKILL"] + td input').value,
                standard: template.querySelector('input[readonly][value*="STANDARD"] + td input').value,
                objectives: template.querySelector('input[readonly][value*="OBJECTIVES"] + td input').value,
                assessment: template.querySelector('input[readonly][value*="ASSESSMENT"] + td input').value,
                teaching_aids: template.querySelector('input[readonly][value*="TEACHING AIDS"] + td input').value,
                refleksi: refleksi
            };

            // Muat data sedia ada
            let allData = {};
            try {
                const response = await fetch('/public/rph_data.json');
                if (response.ok) {
                    allData = await response.json();
                }
            } catch (error) {
                console.warn('Tiada data sedia ada:', error);
            }

            // Pastikan struktur wujud
            if (!allData[user.name]) allData[user.name] = {};
            if (!allData[user.name][tarikh]) allData[user.name][tarikh] = [];

            // Cari dan update atau tambah
            const existingIndex = allData[user.name][tarikh].findIndex(
                r => r.kelas === kelas && r.matapelajaran === matapelajaran
            );

            if (existingIndex >= 0) {
                allData[user.name][tarikh][existingIndex] = data;
            } else {
                allData[user.name][tarikh].push(data);
            }

            // Simpan ke server
            const response = await fetch('/save-rph-draft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(allData)
            });

            const result = await response.json();
            if (result.success) {
                alert('✅ RPH berjaya disimpan!');
                // Tukar butang kepada "SIMPAN"
                document.getElementById(`saveBtn-${index}`).textContent = 'SIMPAN';
            } else {
                alert('❌ Gagal menyimpan: ' + result.message);
            }
        }

        // Fungsi bantu
        function openRphForm(kelas, tarikh) {
            document.getElementById('rphDate').value = tarikh;
            janaRph();
            document.querySelector('.rph-container').scrollIntoView({ behavior: 'smooth' });
        }
    </script>

</body>
</html>